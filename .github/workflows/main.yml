name: Run Script

on:
  workflow_dispatch:

  schedule:
    - cron: '10 5 * * *'
    - cron: '30 5 * * *'
    - cron: '10 6 * * *'
    - cron: '30 6 * * *'
  
jobs:
  run-script:
    runs-on: ubuntu-latest

    steps:
      - name: Check local time in Europe/Rome
        if: github.event_name == 'schedule'
        run: |
          TIME_IN_ROME=$(LC_ALL=C TZ=Europe/Rome date +%H:%M)
          echo "Current local time in Europe/Rome is $TIME_IN_ROME"
          if [[ "$TIME_IN_ROME" != "07:10" && "$TIME_IN_ROME" != "07:30" ]]; then
            echo "Not 07:10 or 07:30 Europe/Rome time â€” skipping the run."
            exit 0
          fi
      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.BOT_TOKEN }}" ] || [ -z "${{ secrets.CHAT_ID }}" ] || [ -z "${{ secrets.URL }}" ] || [ -z "${{ secrets.KEYWORD }}" ]; then
            echo "One or more required secrets are missing!"
            exit 1
          fi
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Node.js 22
        uses: actions/setup-node@v2
        with:
          node-version: '22'
          
      - name: Create .env file
        run: |
          echo "BOT_TOKEN=${{ secrets.BOT_TOKEN }}" >> .env
          echo "CHAT_ID=${{ secrets.CHAT_ID }}" >> .env
          echo "URL=${{ secrets.URL }}" >> .env
          echo "KEYWORD=${{ secrets.KEYWORD }}" >> .env
          
      - name: Install dependencies
        run: npm install

      - name: Run the script
        run: npm run start

      - name: Edit last attempt
        run: |
          date > last_run.txt
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add last_run.txt
          git commit -m "chore: keep alive [skip ci]" || echo "No changes"
          git push
